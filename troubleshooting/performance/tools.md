## 压测工具

### stress-ng 

```
yum install stress-ng
```

模拟cpu压力

```
stress-ng --cpu 2 --cpu-load 80 --timeout 1200s &
```

### 命令解读：

#### `mpstat`

- 来自 **sysstat** 工具包（和 `sar`, `iostat` 一样）。
- 用于显示 **CPU 使用情况** 的统计信息。

------

`-P ALL`

- `-P` 表示指定要显示的 **CPU**。
- `ALL` 代表显示所有 CPU 核心的数据（包括总和和每个核）。
- 如果写 `-P 0` 就只显示 CPU0 的使用率，`-P 1` 只显示 CPU1。

------

 `1`

- 表示 **刷新间隔**，单位是秒。
- 每隔 1 秒输出一次 CPU 使用率统计。
- 可以在后面加次数，比如 `mpstat -P ALL 1 5` → 每隔 1 秒输出一次，共输出 5 次。

```
 mpstat -P ALL 1 5
Linux 4.18.0-553.el8_10.x86_64 (localhost.localdomain) 	08/25/2025 	_x86_64_	(2 CPU)

03:34:55 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
03:34:56 AM  all   80.40    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00   19.60
03:34:56 AM    0   80.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00   20.00
03:34:56 AM    1   80.81    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00   19.19

03:34:56 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
03:34:57 AM  all   79.50    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00   20.50
03:34:57 AM    0   79.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00   21.00
03:34:57 AM    1   80.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00   20.00

03:34:57 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
03:34:58 AM  all   79.50    0.00    0.00    0.00    0.50    0.00    0.00    0.00    0.00   20.00
03:34:58 AM    0   80.81    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00   19.19
03:34:58 AM    1   78.22    0.00    0.00    0.00    0.99    0.00    0.00    0.00    0.00   20.79

```

 结果解读

### **1. 总体情况 (`all`)**

例如第一行：

```
03:34:56 AM  all   80.40    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00   19.60
```

- **%usr = ~80%** → 用户态进程占用 CPU，符合 `stress-ng` 做的数学运算（用户态消耗）。
- **%sys = 0.00%** → 没有明显的内核态负载，说明不是系统调用/内核瓶颈。
- **%iowait = 0.00%** → 没有 I/O 等待，说明不是磁盘或网络卡住 CPU。
- **%irq/%soft = 接近 0%** → 没有中断/软中断压力。
- **%idle = ~20%** → CPU 还有空闲（因为你设置了 80% 的目标负载）。

总结：**整体 CPU 主要忙于用户态计算任务，没有系统瓶颈。**

------

### **2. 单核情况**

```
03:34:56 AM    0   80.00   ...   20.00 idle
03:34:56 AM    1   80.81   ...   19.19 idle
```

- **CPU0 和 CPU1 利用率都在 ~80%**，且分布均匀 → `stress-ng` 把负载均匀分到了 2 个核。
- 没有出现某一个核 100% 而另一个空闲的情况 → **调度器负载均衡正常**。



#### vmstat 1

```
vmstat 1
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 2  0      0 989500   3144 663268    0    0     7     4   64   56  2  0 98  0  0
 1  0      0 989380   3144 663268    0    0     0     0 1759  200 80  0 19  0  0

 1  0      0 989380   3144 663268    0    0     0     0 1720  189 80  0 20  0  0
 2  0      0 989380   3144 663268    0    0     0     0 1709  186 79  0 20  0  0
 2  0      0 989380   3144 663268    0    0     0     0 1738  193 81  0 20  0  0
 1  0      0 989380   3144 663268    0    0     0     0 1702  181 80  1 20  0  0
 2  0      0 989380   3144 663268    0    0     0     0 1711  187 80  0 20  0  0
```

字段含义：

- **procs**
  - `r` → 正在等待 CPU 的进程数（运行队列长度）
  - `b` → 处于不可中断睡眠状态的进程数（一般是等待 I/O）
- **memory**
  - `swpd` → 已使用的 swap 空间
  - `free` → 空闲内存（KB）
  - `buff` → buffer cache（块设备缓存）
  - `cache` → page cache（文件数据缓存）
- **swap**
  - `si` → swap in（从磁盘换入内存，KB/s）
  - `so` → swap out（换出到磁盘，KB/s）
- **io**
  - `bi` → block in（块设备读，KB/s）
  - `bo` → block out（块设备写，KB/s）
- **system**
  - `in` → 每秒中断次数
  - `cs` → 每秒上下文切换次数
- **cpu**
  - `us` → 用户态占用百分比
  - `sy` → 内核态占用百分比
  - `id` → 空闲百分比
  - `wa` → I/O 等待百分比
  - `st` → 被虚拟机偷走的时间（宿主机占用）

### **实际输出解读**

#### 第一行（空闲状态）

```
r=2, b=0, swpd=0, free=989500, buff=3144, cache=663268, si/so=0, bi/bo=7/4, in=64, cs=56, us=2, sy=0, id=98, wa=0, st=0
```

- **CPU 基本空闲（id=98%）**，只有 2% 用户态 → 说明压力测试可能还没开始。
- `r=2` → 系统有 2 个进程在运行队列里（应该是 stress-ng 在跑）。
- I/O 低，swap 没有发生。

#### 第二行（开始压力测试）

```
r=1, b=0, us=80, sy=0, id=19
```

- CPU 用户态占用 80%，idle 只有 19%，符合 `stress-ng --cpu-load 80`。
- `r=1` → 大概只有 1 个核心有进程在等 CPU，用得比较均匀。
- `cs=200` → 上下文切换比较少，说明没有激烈的进程调度竞争。
- I/O (`bi/bo=0`) 没有压力。

#### 后续几行

```
us=79~80%, sy=0, id=20%
```

- 说明 CPU 基本维持在 80% 用户态负载，系统态/IO 都很轻松。
- `r` 值在 1–2 之间浮动，符合 2 核机器在跑 2–4 个 worker。

------

### 📊 **整体结论**

1. **CPU**
   - 用户态负载 80%，和 stress-ng 配置一致 → 压测正常。
   - 系统态 `sy=0`，几乎没有内核开销 → 没有系统调用瓶颈。
   - 没有 I/O 等待（`wa=0`）。
2. **进程调度**
   - `r=1~2`，和 2 核 CPU 相匹配，没有严重排队。
   - `cs≈200/s`，上下文切换很低，说明调度没有成为瓶颈。
3. **内存**
   - `swpd=0`，没有使用 swap。
   - `free≈1GB`，内存压力不大。
4. **I/O**
   - `bi/bo≈0`，没有磁盘/网络 I/O 压力。